generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model EmailTemplate {
  id         String      @id @default(cuid())
  name       String
  subject    String
  body       String
  category   String
  isActive   Boolean     @default(true)
  usageCount Int         @default(0)
  createdAt  DateTime    @default(now())
  updatedAt DateTime @updatedAt
  SentEmail  SentEmail[]
}

model GoogleToken {
  id           String   @id @default(cuid())
  userId       String   @unique
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  scope        String?
  createdAt    DateTime @default(now())
  updatedAt DateTime @updatedAt
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LeadGenOpportunity {
  id               String   @id @default(cuid())
  category         String
  city             String
  state            String   @default("MN")
  searchVolume     Int
  competitionLevel String
  topCompetitors   Json?
  estimatedValue   Int
  prospectCount    Int      @default(0)
  avgRating        Float?
  score            Int
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, city])
}

model MarketTrend {
  id          String    @id @default(cuid())
  category    String
  title       String
  content     String
  source      String?
  trend       String?
  relevance   Float?
  publishedAt DateTime?
  extractedAt DateTime  @default(now())
}

model NewBusiness {
  id           String   @id @default(cuid())
  companyName  String
  businessType String?
  address      String?
  city         String?
  placeId      String?  @unique
  googleRating Float?
  reviewCount  Int?
  firstSeenAt  DateTime
  isNewListing Boolean  @default(true)
  isNewReviews Boolean  @default(false)
  detectedAt   DateTime @default(now())
}

model Prospect {
  id                   String               @id @default(cuid())
  companyName          String
  businessType         String?
  address              String?
  city                 String?
  phone                String?
  email                String?
  website              String?
  gbpUrl               String?
  googleRating         Float?
  reviewCount          Int?
  yearsInBusiness      Int?
  employeeCount        Int?
  categories           String?
  facebook             String?
  instagram            String?
  linkedin             String?
  twitter              String?
  recentReviews        String?
  growthSignals        String?
  techStack            String?
  placeId              String?              @unique
  icpScore             Float?
  dateCollected        DateTime?
  qualificationSignals String?
  dataSource           String?
  searchLocation       String?
  leadScore            Float?
  sentimentScore       Float?
  isHotLead            Boolean              @default(false)
  lastAnalyzed         DateTime?
  aiRecommendations    String?
  anomaliesDetected    String?
  contactedAt          DateTime?
  isConverted          Boolean              @default(false)
  notes                String?
  tags                 String?
  outreachStrategy     String?
  painPoints           String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime @updatedAt
  emailCount           Int                  @default(0)
  emailThreadId        String?
  highTicketScore      Int?
  lastEmailSentAt      DateTime?
  leadGenScore         Int?
  opportunityScore     Int?
  opportunityTags      String[]
  scoringFactors       Json?
  
  // Contact enrichment (owner/decision maker info)
  ownerName            String?
  ownerEmail           String?
  ownerPhone           String?
  ownerLinkedIn        String?

  // Company social profiles
  companyLinkedIn      String?
  companyFacebook      String?
  companyInstagram     String?
  companyTwitter       String?

  // Tech stack detection (from BuiltWith)
  techStackRaw         Json?
  hasCMS               Boolean?
  cmsType              String?
  hasAnalytics         Boolean?
  hasLiveChat          Boolean?
  needsWebsite         Boolean?

  // Enrichment tracking
  enrichedAt           DateTime?
  enrichmentSources    String[]
  
  ProspectActivity     ProspectActivity[]
  ProspectHistorical   ProspectHistorical[]
  ProspectReview       ProspectReview[]
  SentEmail            SentEmail[]
}

model ProspectActivity {
  id           String   @id @default(cuid())
  prospectId   String
  activityType String
  content      String?
  metadata     String?
  createdBy    String?
  createdAt    DateTime @default(now())
  Prospect     Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
}

model ProspectHistorical {
  id            String   @id @default(cuid())
  prospectId    String
  googleRating  Float?
  reviewCount   Int?
  phone         String?
  website       String?
  businessHours String?
  photos        String?
  posts         String?
  recordedAt    DateTime @default(now())
  Prospect      Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
}

model ProspectReview {
  id             String    @id @default(cuid())
  prospectId     String
  reviewId       String?   @unique
  author         String?
  rating         Int?
  text           String?
  publishedAt    DateTime?
  sentiment      String?
  sentimentScore Float?
  extractedAt    DateTime  @default(now())
  Prospect       Prospect  @relation(fields: [prospectId], references: [id], onDelete: Cascade)
}

model SentEmail {
  id            String         @id @default(cuid())
  prospectId    String
  templateId    String?
  subject       String
  body          String
  gmailMsgId    String?
  threadId      String?
  sentAt        DateTime       @default(now())
  openedAt      DateTime?
  clickedAt     DateTime?
  repliedAt     DateTime?
  status        String         @default("sent")
  Prospect      Prospect       @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  EmailTemplate EmailTemplate? @relation(fields: [templateId], references: [id])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemJob {
  id          String    @id @default(cuid())
  jobType     String
  status      String    @default("pending")
  payload     String?
  result      String?
  error       String?
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String       @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String       @default("user")
  firstName     String?
  lastName      String?
  createdAt     DateTime     @default(now())
  updatedAt DateTime @updatedAt
  Account       Account[]
  GoogleToken   GoogleToken?
  Session       Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
