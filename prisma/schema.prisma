
generator client {
    provider      = "prisma-client-js"
    binaryTargets = ["native", "rhel-openssl-3.0.x"]
    output        = "./generated/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String       @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String       @default("user")
  firstName     String?
  lastName      String?
  accounts      Account[]
  sessions      Session[]
  googleToken   GoogleToken?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Onboarding fields
  onboardingCompleted Boolean   @default(false)
  businessUrl         String?
  businessName        String?
  detectedIndustry    String?
  targetIndustries    String[]
  targetCities        String[]
  userGoal            String?   // "find_leads", "monitor_competitors", "grow_agency"
  dashboardConfig     Json?     // Personalized dashboard settings

  // Multi-tenancy: Organization membership
  organizationId      String?
  organization        Organization? @relation(fields: [organizationId], references: [id])
  orgRole             String        @default("member") // "owner", "admin", "member"

  // User's own prospects (when not in an org)
  prospects           Prospect[]
}

// ============================================
// Multi-Tenancy: Organizations & Teams
// ============================================

model Organization {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  members     User[]
  prospects   Prospect[] @relation("OrganizationProspects")
  invites     Invite[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Invite {
  id             String       @id @default(cuid())
  email          String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           String       @default("member") // "admin", "member"
  token          String       @unique @default(cuid())
  expiresAt      DateTime
  createdAt      DateTime     @default(now())

  @@unique([email, organizationId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Prospect {
  id                     String                 @id @default(cuid())
  companyName           String
  businessType          String?
  address               String?
  city                  String?
  phone                 String?
  email                 String?
  website               String?
  gbpUrl                String?
  googleRating          Float?
  reviewCount           Int?
  yearsInBusiness       Int?
  employeeCount         Int?
  categories            String?
  facebook              String?
  instagram             String?
  linkedin              String?
  twitter               String?
  recentReviews         String?
  growthSignals         String?
  techStack             String?
  placeId               String?               @unique
  icpScore              Float?
  dateCollected         DateTime?
  qualificationSignals  String?
  dataSource            String?
  searchLocation        String?
  leadScore             Float?
  sentimentScore        Float?
  isHotLead             Boolean               @default(false)
  lastAnalyzed          DateTime?
  aiRecommendations     String?
  anomaliesDetected     String?
  contactedAt           DateTime?
  isConverted           Boolean               @default(false)
  notes                 String?
  tags                  String?
  outreachStrategy      String?
  painPoints            String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  historicalData        ProspectHistorical[]
  reviews               ProspectReview[]
  activities            ProspectActivity[]

  // Multi-tenancy: Data isolation
  userId                String?
  user                  User?                 @relation(fields: [userId], references: [id])
  organizationId        String?
  organization          Organization?         @relation("OrganizationProspects", fields: [organizationId], references: [id])

  // Enhanced scoring fields
  highTicketScore       Int?                  // 0-100: Commercial/B2B potential
  opportunityScore      Int?                  // 0-100: Marketing gap opportunity
  leadGenScore          Int?                  // 0-100: SEO lead gen site potential
  scoringFactors        Json?                 // Breakdown of scoring components
  opportunityTags       String[]              // ["high_ticket", "boring_goldmine", "leadgen_opp"]

  // Email tracking fields
  emailThreadId         String?               // Gmail thread ID
  lastEmailSentAt       DateTime?
  emailCount            Int                   @default(0)
  sentEmails            SentEmail[]
  
  // AI-generated reports
  reports               ProspectReport[]

  // ===== PHASE 1: Enhanced Contact & Enrichment Fields =====
  
  // Owner/Decision Maker info (from leads-finder)
  ownerName             String?
  ownerEmail            String?
  ownerPhone            String?
  ownerLinkedIn         String?
  ownerTitle            String?
  
  // Company social profiles (from contact scraper)
  companyLinkedIn       String?
  companyFacebook       String?
  companyInstagram      String?
  companyTwitter        String?
  companyYouTube        String?
  
  // Additional emails found
  additionalEmails      String[]              // Array of all emails found
  
  // Tech stack detection (from BuiltWith)
  techStackRaw          Json?                 // Full BuiltWith response
  hasCMS                Boolean?
  cmsType               String?               // WordPress, Wix, Squarespace, etc.
  hasAnalytics          Boolean?
  analyticsType         String?               // Google Analytics, etc.
  hasLiveChat           Boolean?
  liveChatType          String?
  hasBookingWidget      Boolean?
  hasForms              Boolean?
  hasEcommerce          Boolean?
  needsWebsite          Boolean?              // No website or very outdated
  
  // Multi-source ratings
  yelpUrl               String?
  yelpRating            Float?
  yelpReviewCount       Int?
  angiRating            Float?
  angiReviewCount       Int?
  bbbRating             String?               // A+, A, B, etc.
  bbbUrl                String?
  facebookRating        Float?
  facebookReviewCount   Int?
  
  // Enrichment tracking
  enrichedAt            DateTime?
  enrichmentSources     String[]              // ["google_maps", "contact_scraper", "builtwith"]
  lastEnrichmentError   String?
}

model ProspectHistorical {
  id            String    @id @default(cuid())
  prospectId    String
  prospect      Prospect  @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  googleRating  Float?
  reviewCount   Int?
  phone         String?
  website       String?
  businessHours String?
  photos        String?
  posts         String?
  recordedAt    DateTime  @default(now())
}

model ProspectReview {
  id            String    @id @default(cuid())
  prospectId    String
  prospect      Prospect  @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  reviewId      String?   @unique
  author        String?
  rating        Int?
  text          String?
  publishedAt   DateTime?
  sentiment     String?
  sentimentScore Float?
  extractedAt   DateTime  @default(now())
}

model MarketTrend {
  id          String    @id @default(cuid())
  category    String
  title       String
  content     String
  source      String?
  trend       String?
  relevance   Float?
  publishedAt DateTime?
  extractedAt DateTime  @default(now())
}

model NewBusiness {
  id               String    @id @default(cuid())
  companyName      String
  businessType     String?
  address          String?
  city             String?
  placeId          String?   @unique
  googleRating     Float?
  reviewCount      Int?
  firstSeenAt      DateTime
  isNewListing     Boolean   @default(true)
  isNewReviews     Boolean   @default(false)
  detectedAt       DateTime  @default(now())
}

model ProspectActivity {
  id          String    @id @default(cuid())
  prospectId  String
  prospect    Prospect  @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  activityType String  // 'note', 'status_change', 'ai_analysis', 'contact_attempt', 'tag_added'
  content     String?
  metadata    String?  // JSON string for additional data
  createdBy   String?
  createdAt   DateTime  @default(now())
}

model SystemJob {
  id          String    @id @default(cuid())
  jobType     String
  status      String    @default("pending")
  payload     String?
  result      String?
  error       String?
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
}

// ============================================
// Email & Outreach Models
// ============================================

model EmailTemplate {
  id          String      @id @default(cuid())
  name        String
  subject     String
  body        String      @db.Text    // With {{variables}} for mail merge
  category    String      // "initial_outreach", "follow_up", "value_offer"
  isActive    Boolean     @default(true)
  usageCount  Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  sentEmails  SentEmail[]
}

model SentEmail {
  id          String         @id @default(cuid())
  prospectId  String
  prospect    Prospect       @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  templateId  String?
  template    EmailTemplate? @relation(fields: [templateId], references: [id])
  subject     String
  body        String         @db.Text
  gmailMsgId  String?        // Gmail message ID for tracking
  threadId    String?        // Gmail thread ID
  sentAt      DateTime       @default(now())
  openedAt    DateTime?
  clickedAt   DateTime?
  repliedAt   DateTime?
  status      String         @default("sent") // "sent", "opened", "clicked", "replied", "bounced"
}

model LeadGenOpportunity {
  id               String   @id @default(cuid())
  category         String   // "plumber", "roofer", "hvac", etc.
  city             String
  state            String   @default("MN")
  searchVolume     Int      // Monthly search volume estimate
  competitionLevel String   // "low", "medium", "high"
  topCompetitors   Json?    // Top ranking sites info
  estimatedValue   Int      // $ per lead estimate
  prospectCount    Int      @default(0) // How many prospects in this niche
  avgRating        Float?   // Average rating in this niche
  score            Int      // Overall opportunity score 0-100
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([category, city])
}

// Store Gmail OAuth tokens per user
model GoogleToken {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String   @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime
  scope        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// AI-generated prospect reports (shareable landing pages)
model ProspectReport {
  id              String   @id @default(cuid())
  prospectId      String
  prospect        Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  
  // Generated content
  headline        String
  strengths       String[]
  opportunities   String[]
  competitorInsights String @db.Text
  ctaText         String
  estimatedValue  String
  
  // Sharing
  shareToken      String   @unique @default(cuid())
  views           Int      @default(0)
  lastViewedAt    DateTime?
  
  // Metadata
  generatedAt     DateTime @default(now())
  expiresAt       DateTime?
}

